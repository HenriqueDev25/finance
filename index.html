<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FinancePro - Controle Financeiro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, updateDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAwlgt9nTGQq3gRSTULlIJw58Cdt1Nb5s",
            authDomain: "financeiro-e4c33.firebaseapp.com",
            projectId: "financeiro-e4c33",
            storageBucket: "financeiro-e4c33.firebasestorage.app",
            messagingSenderId: "908075758451",
            appId: "1:908075758451:web:12540b872c88b6b02b8b06",
            measurementId: "G-B9W177B2XZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebase = {
            db,
            auth,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            orderBy,
            deleteDoc,
            doc,
            updateDoc,
            onSnapshot,
            getDoc,
            setDoc,
            onAuthStateChanged,
            signInAnonymously,
            signOut
        };
    </script>
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        :root {
            --primary: #000000;
            --primary-dark: #333333;
            --secondary: #666666;
            --success: #222222;
            --danger: #444444;
            --warning: #555555;
            --light: #ffffff;
            --dark: #000000;
            --gray: #888888;
            --light-gray: #f0f0f0;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        html {
            height: -webkit-fill-available;
        }
        
        /* Safe area adjustments */
        .safe-area-top {
            padding-top: var(--safe-top);
            background: var(--dark);
        }
        
        .safe-area-bottom {
            padding-bottom: var(--safe-bottom);
        }
        
        /* Container responsivo */
        .container {
            width: 100%;
            max-width: 100%;
            padding: 0 16px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
                padding: 0 20px;
            }
        }
        
        /* Header mobile-first */
        header {
            background: var(--dark);
            color: var(--light);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .logo-icon {
            font-size: 1.8rem;
            background: rgba(255, 255, 255, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }
        
        .logo-text p {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 300;
            display: none;
        }
        
        @media (min-width: 375px) {
            .logo-text p {
                display: block;
            }
        }
        
        /* Menu mobile */
        .mobile-menu {
            display: flex;
            gap: 10px;
        }
        
        .menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .menu-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }
        
        /* Dashboard mobile */
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 20px 0;
            padding: 0 4px;
        }
        
        @media (min-width: 414px) {
            .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(calc(50% - 8px), 1fr));
                gap: 16px;
            }
        }
        
        .card {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--light-gray);
            -webkit-touch-callout: none;
            user-select: none;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--dark);
        }
        
        .income-card::before {
            background: var(--dark);
        }
        
        .expense-card::before {
            background: var(--secondary);
        }
        
        .balance-card::before {
            background: var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }
        
        .income-icon {
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }
        
        .expense-icon {
            background: rgba(102, 102, 102, 0.05);
            color: var(--secondary);
        }
        
        .balance-icon {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        
        .income-value {
            color: var(--dark);
        }
        
        .expense-value {
            color: var(--secondary);
        }
        
        .balance-value {
            color: var(--primary);
        }
        
        .card-subtitle {
            color: var(--gray);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Formul√°rio mobile-friendly */
        .data-entry {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--light-gray);
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title i {
            color: var(--dark);
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        @media (min-width: 414px) {
            .form-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .form-row .form-group:last-child:nth-child(odd) {
                grid-column: span 2;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        input, select {
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--light-gray);
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--light);
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            color: var(--dark);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--light);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Bot√µes touch-friendly */
        .btn {
            padding: 16px 24px;
            border-radius: 14px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1rem;
            letter-spacing: 0.3px;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn-primary {
            background: var(--dark);
            color: var(--light);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--light-gray);
        }
        
        .btn-warning {
            background: var(--secondary);
            color: var(--light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--light);
        }
        
        /* Relat√≥rios mobile */
        .reports-section {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--light-gray);
        }
        
        .reports-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }
        
        @media (min-width: 414px) {
            .reports-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }
        
        .report-card {
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--light-gray);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .report-card:active {
            border-color: var(--primary);
            transform: scale(0.98);
        }
        
        .report-icon {
            font-size: 2rem;
            margin-bottom: 16px;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }
        
        .excel-icon {
            background: rgba(33, 150, 83, 0.1);
            color: #219653;
        }
        
        .word-icon {
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }
        
        .pdf-icon {
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }
        
        .report-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .report-description {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* Tabela mobile scrollable */
        .transaction-list {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--light-gray);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid var(--light-gray);
            -webkit-overflow-scrolling: touch;
            margin: 0 -20px;
            width: calc(100% + 40px);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 600px;
        }
        
        thead {
            background: var(--dark);
            position: sticky;
            left: 0;
        }
        
        th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--light);
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        th:first-child {
            border-top-left-radius: 14px;
            padding-left: 20px;
        }
        
        th:last-child {
            border-top-right-radius: 14px;
            padding-right: 20px;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--light-gray);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        td:first-child {
            padding-left: 20px;
        }
        
        td:last-child {
            padding-right: 20px;
        }
        
        tbody tr:active {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .transaction-income {
            color: var(--dark);
            font-weight: 700;
        }
        
        .transaction-expense {
            color: var(--secondary);
            font-weight: 700;
        }
        
        .transaction-category {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .category-salary {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--dark);
        }
        
        .category-investment {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--dark);
        }
        
        .category-food {
            background-color: rgba(102, 102, 102, 0.1);
            color: var(--secondary);
        }
        
        .category-transport {
            background-color: rgba(102, 102, 102, 0.1);
            color: var(--secondary);
        }
        
        .category-housing {
            background-color: rgba(68, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .category-other {
            background-color: rgba(136, 136, 136, 0.1);
            color: var(--gray);
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .delete-btn:active {
            background-color: rgba(68, 68, 68, 0.1);
            transform: scale(0.9);
        }
        
        /* Charts mobile */
        .chart-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }
        
        .chart-card {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--light-gray);
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-box {
            flex: 1;
            min-height: 250px;
            position: relative;
        }
        
        /* Footer mobile */
        footer {
            text-align: center;
            padding: 24px 20px;
            color: var(--gray);
            font-size: 0.85rem;
            margin-top: 30px;
            border-top: 1px solid var(--light-gray);
            background: var(--light);
        }
        
        /* Estado vazio */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--light-gray);
            opacity: 0.7;
        }
        
        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 12px;
            color: var(--dark);
        }
        
        /* Modal mobile-friendly */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            padding-top: calc(20px + var(--safe-top));
            padding-bottom: calc(20px + var(--safe-bottom));
        }
        
        .modal-content {
            background-color: var(--light);
            width: 100%;
            max-width: 500px;
            border-radius: 24px;
            padding: 24px;
            max-height: calc(100vh - 40px - var(--safe-top) - var(--safe-bottom));
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.6rem;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }
        
        .close-modal:active {
            background-color: var(--light-gray);
            color: var(--dark);
        }
        
        .modal-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--dark);
            padding-right: 40px;
            line-height: 1.3;
        }
        
        .modal-body {
            line-height: 1.6;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .analysis-section {
            margin-bottom: 24px;
            padding: 16px;
            border-radius: 15px;
            background-color: var(--light-gray);
        }
        
        .analysis-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .suggestion-item {
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 12px;
            background-color: var(--light);
            border-left: 5px solid var(--success);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .suggestion-item.warning {
            border-left-color: var(--warning);
        }
        
        .suggestion-item.danger {
            border-left-color: var(--danger);
        }
        
        /* Bottom navigation para mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--light);
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-item:active {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--primary);
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        /* Swipe gestures hint */
        .swipe-hint {
            text-align: center;
            padding: 10px;
            color: var(--gray);
            font-size: 0.8rem;
            display: none;
        }
        
        @media (max-width: 768px) {
            .swipe-hint {
                display: block;
            }
        }
        
        /* Loader para a√ß√µes */
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notifica√ß√µes toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: var(--light);
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            font-weight: 500;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Sele√ß√£o de data melhorada para mobile */
        input[type="date"] {
            min-height: 52px;
        }
        
        /* Ajustes espec√≠ficos para iPhone */
        @supports (-webkit-touch-callout: none) {
            input, select, .btn {
                font-size: 16px;
            }
            
            .modal-content {
                border-radius: 28px;
            }
            
            .bottom-nav {
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                background: rgba(255, 255, 255, 0.95);
            }
        }
        
        /* Dark mode support - sempre preto e branco */
        body[data-dark-mode="true"] {
            background-color: #121212;
            color: #ffffff;
        }
        
        body[data-dark-mode="true"] .card,
        body[data-dark-mode="true"] .data-entry,
        body[data-dark-mode="true"] .transaction-list,
        body[data-dark-mode="true"] .chart-card,
        body[data-dark-mode="true"] .reports-section,
        body[data-dark-mode="true"] .report-card,
        body[data-dark-mode="true"] footer {
            background-color: #1e1e1e;
            border-color: #333;
            color: #ffffff;
        }
        
        body[data-dark-mode="true"] input,
        body[data-dark-mode="true"] select {
            background-color: #2d2d2d;
            border-color: #444;
            color: #ffffff;
        }
        
        body[data-dark-mode="true"] input:focus,
        body[data-dark-mode="true"] select:focus {
            background-color: #333;
        }
        
        body[data-dark-mode="true"] .table-container {
            border-color: #333;
        }
        
        body[data-dark-mode="true"] .analysis-section {
            background-color: #252525;
        }
        
        body[data-dark-mode="true"] .suggestion-item {
            background-color: #2d2d2d;
        }
        
        body[data-dark-mode="true"] .bottom-nav {
            background: rgba(30, 30, 30, 0.95);
            border-color: #333;
        }
        
        body[data-dark-mode="true"] .nav-item {
            color: #888;
        }
        
        body[data-dark-mode="true"] .nav-item.active {
            color: #ffffff;
        }
        
        body[data-dark-mode="true"] .btn-secondary {
            background: #2d2d2d;
            color: #ffffff;
            border-color: #444;
        }
        
        body[data-dark-mode="true"] .card-title,
        body[data-dark-mode="true"] .section-title,
        body[data-dark-mode="true"] label {
            color: #ffffff;
        }
        
        body[data-dark-mode="true"] .card-subtitle,
        body[data-dark-mode="true"] .report-description {
            color: #aaa;
        }
        
        /* Configura√ß√µes extras */
        .settings-section {
            background-color: var(--light);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--light-gray);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .setting-info p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* Modal de Exporta√ß√£o */
        .export-modal-content {
            max-width: 400px;
        }
        
        .export-option {
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--light-gray);
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .export-option:last-child {
            margin-bottom: 0;
        }
        
        .export-option:hover {
            border-color: var(--dark);
            transform: translateY(-2px);
        }
        
        .export-option.selected {
            border-color: var(--dark);
            background: rgba(0, 0, 0, 0.05);
        }
        
        .export-option h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-option p {
            font-size: 0.85rem;
            color: var(--gray);
            margin-left: 34px;
        }
        
        /* Barra de progresso */
        .progress-bar {
            height: 4px;
            background: var(--light-gray);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--dark);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Bot√µes de exporta√ß√£o na configura√ß√£o */
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-btn {
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        
        /* Se√ß√£o de exporta√ß√£o avan√ßada */
        .export-filters {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .export-filters.show {
            display: block;
        }
        
        /* Switch toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--dark);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Conex√£o banco de dados status */
        .db-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        
        .db-status.online {
            background-color: rgba(0, 128, 0, 0.1);
            color: green;
        }
        
        .db-status.offline {
            background-color: rgba(255, 0, 0, 0.1);
            color: red;
        }
        
        .sync-button {
            margin-left: auto;
            padding: 4px 8px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Safe area top -->
    <div class="safe-area-top">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="logo-text">
                            <h1>Finance<span style="color: #888;">Pro</span></h1>
                            <p>Controle financeiro</p>
                        </div>
                    </div>
                    <div class="mobile-menu">
                        <button class="menu-btn" id="menuBtn">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>
    </div>
    
    <main class="container">
        <!-- Dica de swipe -->
        <div class="swipe-hint">
            <i class="fas fa-arrow-left"></i> Deslize para navegar <i class="fas fa-arrow-right"></i>
        </div>
        
        <!-- Status da conex√£o com o banco -->
        <div id="dbStatus" class="db-status" style="display: none;">
            <span id="dbStatusIcon"><i class="fas fa-database"></i></span>
            <span id="dbStatusText">Conectando...</span>
            <button id="dbSyncBtn" class="btn btn-secondary sync-button" style="display: none;">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Dashboard -->
        <div class="dashboard">
            <div class="card income-card" id="incomeCard">
                <div class="card-header">
                    <h2 class="card-title">Renda</h2>
                    <div class="card-icon income-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="card-value income-value" id="totalIncome">R$ 0,00</div>
                <p class="card-subtitle">Total de receitas</p>
            </div>
            
            <div class="card expense-card" id="expenseCard">
                <div class="card-header">
                    <h2 class="card-title">Despesas</h2>
                    <div class="card-icon expense-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
                <div class="card-value expense-value" id="totalExpense">R$ 0,00</div>
                <p class="card-subtitle">Total de gastos</p>
            </div>
        </div>
        
        <div class="card balance-card" id="balanceCard" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title">Saldo Dispon√≠vel</h2>
                <div class="card-icon balance-icon">
                    <i class="fas fa-piggy-bank"></i>
                </div>
            </div>
            <div class="card-value balance-value" id="totalBalance">R$ 0,00</div>
            <p class="card-subtitle">Saldo ap√≥s despesas</p>
        </div>
        
        <div class="data-entry" id="dataEntrySection">
            <h2 class="section-title"><i class="fas fa-plus-circle"></i> Nova Transa√ß√£o</h2>
            <form id="transactionForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="description"><i class="fas fa-file-alt"></i> Descri√ß√£o</label>
                        <input type="text" id="description" placeholder="Sal√°rio, Mercado, etc..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount"><i class="fas fa-money-bill"></i> Valor (R$)</label>
                        <input type="number" id="amount" step="0.01" min="0.01" placeholder="0,00" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="type"><i class="fas fa-exchange-alt"></i> Tipo</label>
                        <select id="type" required>
                            <option value="income">Renda</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category"><i class="fas fa-tag"></i> Categoria</label>
                        <select id="category" required>
                            <option value="salary">Sal√°rio</option>
                            <option value="investment">Investimentos</option>
                            <option value="food">Alimenta√ß√£o</option>
                            <option value="transport">Transporte</option>
                            <option value="housing">Moradia</option>
                            <option value="utilities">Contas</option>
                            <option value="entertainment">Lazer</option>
                            <option value="health">Sa√∫de</option>
                            <option value="education">Educa√ß√£o</option>
                            <option value="other">Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date"><i class="fas fa-calendar"></i> Data</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i>
                            Adicionar
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Se√ß√£o de Relat√≥rios simplificada -->
        <div class="reports-section" id="reportsSection" style="display: none;">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Relat√≥rios</h2>
            <div class="reports-grid">
                <div class="report-card">
                    <div class="report-icon" style="background: rgba(0, 0, 0, 0.05); color: var(--dark);">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <h3 class="report-title">An√°lise Mensal</h3>
                    <p class="report-description">Visualize seus gastos por categoria</p>
                    <button class="btn btn-secondary" onclick="showSection('transactions')">
                        <i class="fas fa-eye"></i>
                        Ver Gr√°ficos
                    </button>
                </div>
                
                <div class="report-card">
                    <div class="report-icon" style="background: rgba(0, 0, 0, 0.05); color: var(--dark);">
                        <i class="fas fa-history"></i>
                    </div>
                    <h3 class="report-title">Hist√≥rico Completo</h3>
                    <p class="report-description">Todas as transa√ß√µes registradas</p>
                    <button class="btn btn-secondary" onclick="showSection('transactions')">
                        <i class="fas fa-list"></i>
                        Ver Transa√ß√µes
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Configura√ß√µes com Exporta√ß√£o -->
        <div class="settings-section" id="settingsSection" style="display: none;">
            <h2 class="section-title"><i class="fas fa-cog"></i> Configura√ß√µes</h2>
            
            <!-- Status do Banco de Dados -->
            <div id="databaseSettings" style="margin-bottom: 25px;">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--dark);">
                    <i class="fas fa-database"></i> Firebase Firestore
                </h3>
                
                <!-- Informa√ß√µes do Usu√°rio -->
                <div id="userInfo" style="margin-bottom: 15px; padding: 15px; background: var(--light-gray); border-radius: 10px; display: none;">
                    <p style="font-size: 0.9rem; color: var(--dark); margin-bottom: 5px;">
                        <i class="fas fa-user"></i> Usu√°rio: <span id="userId">Carregando...</span>
                    </p>
                    <button class="btn btn-secondary" id="logoutBtn" style="margin-top: 10px; padding: 8px 12px;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3><i class="fas fa-cloud"></i> Sincroniza√ß√£o em Tempo Real</h3>
                        <p>Ativar sincroniza√ß√£o autom√°tica com Firebase</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="firebaseSyncToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="firebaseSyncControls">
                    <div style="margin: 15px 0;">
                        <button class="btn btn-secondary export-btn" id="syncToFirebaseBtn">
                            <i class="fas fa-upload"></i> For√ßar Sincroniza√ß√£o
                        </button>
                        <button class="btn btn-secondary export-btn" id="clearFirebaseBtn" style="margin-top: 10px; background: var(--danger);">
                            <i class="fas fa-trash"></i> Limpar Nuvem
                        </button>
                    </div>
                    
                    <div style="font-size: 0.85rem; color: var(--gray); padding: 10px; background: var(--light-gray); border-radius: 10px;">
                        <p><i class="fas fa-info-circle"></i> √öltima sincroniza√ß√£o: <span id="lastSyncTime">Agora</span></p>
                        <p>Transa√ß√µes na nuvem: <span id="firebaseTransactionCount">0</span></p>
                        <p>Status: <span id="firebaseStatus">Conectando...</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Configura√ß√µes de Tema -->
            <div class="setting-item">
                <div class="setting-info">
                    <h3><i class="fas fa-moon"></i> Modo Escuro</h3>
                    <p>Alternar entre tema claro e escuro</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- Se√ß√£o de Exporta√ß√£o -->
            <div style="margin: 25px 0;">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--dark);">
                    <i class="fas fa-file-export" style="color: #219653;"></i> Exportar Dados
                </h3>
                
                <div class="export-buttons">
                    <button class="btn btn-primary export-btn" id="quickExportBtn">
                        <i class="fas fa-file-excel"></i> Exportar para Excel (Completo)
                    </button>
                    
                    <button class="btn btn-secondary export-btn" id="advancedExportBtn">
                        <i class="fas fa-cogs"></i> Exporta√ß√£o Avan√ßada
                    </button>
                    
                    <button class="btn btn-secondary export-btn" id="exportBackupBtn">
                        <i class="fas fa-download"></i> Backup em JSON
                    </button>
                </div>
                
                <!-- Filtros para exporta√ß√£o avan√ßada -->
                <div class="export-filters" id="exportFilters">
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">
                            <i class="fas fa-filter"></i> Filtrar por Per√≠odo
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.85rem;">Data Inicial</label>
                                <input type="date" id="startDate" style="padding: 10px; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.85rem;">Data Final</label>
                                <input type="date" id="endDate" style="padding: 10px; font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">
                            <i class="fas fa-exchange-alt"></i> Filtrar por Tipo
                        </label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="filterIncome" checked>
                                <span style="font-size: 0.9rem;">Renda</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="filterExpense" checked>
                                <span style="font-size: 0.9rem;">Despesas</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="exportFilteredBtn" style="width: 100%;">
                        <i class="fas fa-download"></i> Exportar com Filtros
                    </button>
                </div>
            </div>
            
            <!-- Gerenciamento de Dados -->
            <div style="margin: 25px 0;">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--dark);">
                    <i class="fas fa-database"></i> Gerenciamento de Dados
                </h3>
                
                <div class="export-buttons">
                    <button class="btn btn-secondary export-btn" id="loadSampleDataBtn">
                        <i class="fas fa-database"></i> Carregar Dados de Exemplo
                    </button>
                    
                    <button class="btn btn-danger export-btn" id="clearHistoryBtn">
                        <i class="fas fa-trash-alt"></i> Limpar Todo o Hist√≥rico
                    </button>
                </div>
            </div>
            
            <!-- Informa√ß√µes do Sistema -->
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: var(--dark);">
                    <i class="fas fa-info-circle"></i> Informa√ß√µes
                </h3>
                <div style="font-size: 0.85rem; color: var(--gray);">
                    <p>Transa√ß√µes armazenadas: <span id="transactionCount">0</span></p>
                    <p>Transa√ß√µes na nuvem: <span id="cloudCount">0</span></p>
                    <p>√öltima atualiza√ß√£o: <span id="lastUpdate">-</span></p>
                    <p>Espa√ßo utilizado: <span id="storageUsed">0 KB</span></p>
                </div>
            </div>
        </div>
        
        <div class="transaction-list" id="transactionsSection">
            <h2 class="section-title"><i class="fas fa-list-alt"></i> Transa√ß√µes Recentes</h2>
            
            <div class="table-container">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Fonte</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Transa√ß√µes ser√£o inseridas aqui via JavaScript -->
                    </tbody>
                </table>
                
                <div id="emptyTransactions" class="empty-state">
                    <i class="fas fa-receipt"></i>
                    <h3>Nenhuma transa√ß√£o</h3>
                    <p>Adicione sua primeira transa√ß√£o acima</p>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-card">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Gastos por Categoria</h2>
                <div class="chart-box">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Evolu√ß√£o Mensal</h2>
                <div class="chart-box">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Espa√ßo extra para bottom nav -->
        <div class="safe-area-bottom" style="height: 80px;"></div>
    </main>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav safe-area-bottom">
        <button class="nav-item active" id="navDashboard">
            <i class="fas fa-home nav-icon"></i>
            <span>In√≠cio</span>
        </button>
        <button class="nav-item" id="navAdd">
            <i class="fas fa-plus-circle nav-icon"></i>
            <span>Adicionar</span>
        </button>
        <button class="nav-item" id="navTransactions">
            <i class="fas fa-list-alt nav-icon"></i>
            <span>Transa√ß√µes</span>
        </button>
        <button class="nav-item" id="navSettings">
            <i class="fas fa-cog nav-icon"></i>
            <span>Config</span>
        </button>
    </div>
    
    <!-- Modal de Exporta√ß√£o -->
    <div class="modal" id="exportModal">
        <div class="modal-content export-modal-content">
            <button class="close-modal" id="closeExportModal">&times;</button>
            <h2 class="modal-title">Exportar para Excel</h2>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">Escolha o tipo de exporta√ß√£o:</p>
                
                <div class="export-option" data-export-type="full">
                    <h4><i class="fas fa-file-excel" style="color: #219653;"></i> Exporta√ß√£o Completa</h4>
                    <p>Todas as transa√ß√µes com formata√ß√£o profissional</p>
                </div>
                
                <div class="export-option" data-export-type="monthly">
                    <h4><i class="fas fa-calendar-alt" style="color: #666;"></i> Relat√≥rio Mensal</h4>
                    <p>Transa√ß√µes do m√™s atual com resumo</p>
                </div>
                
                <div class="export-option" data-export-type="categories">
                    <h4><i class="fas fa-chart-pie" style="color: #666;"></i> An√°lise por Categoria</h4>
                    <p>Relat√≥rio detalhado por categorias de gastos</p>
                </div>
                
                <button class="btn btn-primary" id="startExportBtn" style="margin-top: 20px; width: 100%;">
                    <i class="fas fa-download"></i> Iniciar Exporta√ß√£o
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Progresso da Exporta√ß√£o -->
    <div class="modal" id="exportProgressModal">
        <div class="modal-content export-modal-content">
            <h2 class="modal-title">Exportando para Excel</h2>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div class="loader" style="margin: 0 auto 20px; display: block;"></div>
                    <p id="exportStatus">Preparando dados para exporta√ß√£o...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exportProgress" style="width: 0%"></div>
                    </div>
                    <p id="exportDetails" style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;">
                        Processando transa√ß√µes...
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de An√°lise -->
    <div class="modal" id="analysisModal">
        <div class="modal-content">
            <button class="close-modal" id="closeAnalysisModal">&times;</button>
            <h2 class="modal-title">An√°lise Financeira</h2>
            <div class="modal-body">
                <div id="analysisContent">
                    <!-- Conte√∫do gerado dinamicamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="confirmModal">
        <div class="modal-content export-modal-content">
            <h2 class="modal-title">Confirmar A√ß√£o</h2>
            <div class="modal-body">
                <p id="confirmMessage">Tem certeza que deseja realizar esta a√ß√£o?</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" id="confirmCancel">Cancelar</button>
                    <button class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sincroniza√ß√£o -->
    <div class="modal" id="syncModal">
        <div class="modal-content export-modal-content">
            <h2 class="modal-title">Sincronizando com Firebase</h2>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div class="loader" style="margin: 0 auto 20px; display: block;"></div>
                    <p id="syncStatus">Conectando ao Firebase...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="syncProgress" style="width: 0%"></div>
                    </div>
                    <p id="syncDetails" style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;">
                        Iniciando sincroniza√ß√£o...
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>
    
    <script>
// ========== VARI√ÅVEIS GLOBAIS ==========
let transactions = [];
let categoryChart = null;
let monthlyChart = null;
let currentSection = 'dashboard';
let selectedExportType = 'full';
let isFirebaseSyncEnabled = true;
let firebaseConnectionStatus = 'connecting';
let firebaseTransactionsCount = 0;
let lastSyncTime = new Date();
let currentUserId = null;
let firebaseUnsubscribe = null;

// Elementos DOM
const transactionForm = document.getElementById('transactionForm');
const transactionsBody = document.getElementById('transactionsBody');
const emptyTransactions = document.getElementById('emptyTransactions');
const totalIncomeElement = document.getElementById('totalIncome');
const totalExpenseElement = document.getElementById('totalExpense');
const totalBalanceElement = document.getElementById('totalBalance');
const exportModal = document.getElementById('exportModal');
const exportProgressModal = document.getElementById('exportProgressModal');
const closeExportModal = document.getElementById('closeExportModal');
const exportStatus = document.getElementById('exportStatus');
const exportProgress = document.getElementById('exportProgress');
const exportDetails = document.getElementById('exportDetails');
const quickExportBtn = document.getElementById('quickExportBtn');
const advancedExportBtn = document.getElementById('advancedExportBtn');
const exportBackupBtn = document.getElementById('exportBackupBtn');
const startExportBtn = document.getElementById('startExportBtn');
const exportOptions = document.querySelectorAll('.export-option');
const exportFilters = document.getElementById('exportFilters');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const filterIncome = document.getElementById('filterIncome');
const filterExpense = document.getElementById('filterExpense');
const exportFilteredBtn = document.getElementById('exportFilteredBtn');
const analysisModal = document.getElementById('analysisModal');
const confirmModal = document.getElementById('confirmModal');
const closeAnalysisModal = document.getElementById('closeAnalysisModal');
const analysisContent = document.getElementById('analysisContent');
const toast = document.getElementById('toast');
const darkModeToggle = document.getElementById('darkModeToggle');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const loadSampleDataBtn = document.getElementById('loadSampleDataBtn');
const confirmMessage = document.getElementById('confirmMessage');
const confirmCancel = document.getElementById('confirmCancel');
const confirmAction = document.getElementById('confirmAction');
const transactionCount = document.getElementById('transactionCount');
const cloudCount = document.getElementById('cloudCount');
const lastUpdate = document.getElementById('lastUpdate');
const storageUsed = document.getElementById('storageUsed');

// Elementos do Firebase
const dbStatus = document.getElementById('dbStatus');
const dbStatusIcon = document.getElementById('dbStatusIcon');
const dbStatusText = document.getElementById('dbStatusText');
const dbSyncBtn = document.getElementById('dbSyncBtn');
const firebaseSyncToggle = document.getElementById('firebaseSyncToggle');
const firebaseSyncControls = document.getElementById('firebaseSyncControls');
const syncToFirebaseBtn = document.getElementById('syncToFirebaseBtn');
const clearFirebaseBtn = document.getElementById('clearFirebaseBtn');
const lastSyncTimeElement = document.getElementById('lastSyncTime');
const firebaseTransactionCount = document.getElementById('firebaseTransactionCount');
const firebaseStatus = document.getElementById('firebaseStatus');
const syncModal = document.getElementById('syncModal');
const syncStatus = document.getElementById('syncStatus');
const syncProgress = document.getElementById('syncProgress');
const syncDetails = document.getElementById('syncDetails');
const userInfo = document.getElementById('userInfo');
const userId = document.getElementById('userId');
const logoutBtn = document.getElementById('logoutBtn');

// Elementos de navega√ß√£o
const navDashboard = document.getElementById('navDashboard');
const navAdd = document.getElementById('navAdd');
const navTransactions = document.getElementById('navTransactions');
const navSettings = document.getElementById('navSettings');
const menuBtn = document.getElementById('menuBtn');

// Se√ß√µes
const dataEntrySection = document.getElementById('dataEntrySection');
const transactionsSection = document.getElementById('transactionsSection');
const reportsSection = document.getElementById('reportsSection');
const settingsSection = document.getElementById('settingsSection');
const incomeCard = document.getElementById('incomeCard');
const expenseCard = document.getElementById('expenseCard');
const balanceCard = document.getElementById('balanceCard');

// ========== INICIALIZA√á√ÉO ==========
document.addEventListener('DOMContentLoaded', function() {
    // Configurar data atual
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
    
    // Configurar datas para filtros
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    startDateInput.value = firstDay.toISOString().slice(0, 10);
    endDateInput.value = today.toISOString().slice(0, 10);
    
    // Carregar configura√ß√µes
    loadSettings();
    
    // Carregar transa√ß√µes do localStorage
    loadLocalTransactions();
    
    // Inicializar Firebase (com tratamento de erro melhorado)
    initializeFirebase();
    
    // Configurar eventos
    setupEventListeners();
    
    // Verificar modo escuro
    checkDarkMode();
    
    // Atualizar informa√ß√µes do sistema
    updateSystemInfo();
    
    // Mostrar se√ß√£o inicial
    showSection('dashboard');
});

// ========== CONFIGURAR EVENT LISTENERS ==========
function setupEventListeners() {
    // Formul√°rio de transa√ß√£o
    transactionForm.addEventListener('submit', handleAddTransaction);
    
    // Bot√µes de exporta√ß√£o
    quickExportBtn.addEventListener('click', () => handleExportExcel('full'));
    advancedExportBtn.addEventListener('click', toggleExportFilters);
    exportBackupBtn.addEventListener('click', handleExportBackup);
    exportFilteredBtn.addEventListener('click', () => handleExportExcel('custom'));
    startExportBtn.addEventListener('click', handleStartExport);
    
    // Op√ß√µes de exporta√ß√£o no modal
    exportOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remover sele√ß√£o anterior
            exportOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Selecionar nova op√ß√£o
            this.classList.add('selected');
            selectedExportType = this.dataset.exportType;
        });
    });
    
    // Modal de exporta√ß√£o
    closeExportModal.addEventListener('click', () => closeModal(exportModal));
    
    // Modal de an√°lise
    closeAnalysisModal.addEventListener('click', () => closeModal(analysisModal));
    
    // Modal de confirma√ß√£o
    confirmCancel.addEventListener('click', () => closeModal(confirmModal));
    
    // Configura√ß√µes
    darkModeToggle.addEventListener('change', toggleDarkMode);
    clearHistoryBtn.addEventListener('click', () => showClearHistoryConfirm());
    loadSampleDataBtn.addEventListener('click', handleSampleData);
    
    // Configura√ß√µes do Firebase
    firebaseSyncToggle.addEventListener('change', toggleFirebaseSync);
    dbSyncBtn.addEventListener('click', checkFirebaseConnection);
    syncToFirebaseBtn.addEventListener('click', () => syncAllToFirebase());
    clearFirebaseBtn.addEventListener('click', () => showClearFirebaseConfirm());
    logoutBtn.addEventListener('click', handleLogout);
    
    // Navega√ß√£o inferior
    navDashboard.addEventListener('click', () => showSection('dashboard'));
    navAdd.addEventListener('click', () => showSection('add'));
    navTransactions.addEventListener('click', () => showSection('transactions'));
    navSettings.addEventListener('click', () => showSection('settings'));
    
    // Cards do dashboard (para acesso r√°pido)
    incomeCard.addEventListener('click', () => filterByType('income'));
    expenseCard.addEventListener('click', () => filterByType('expense'));
    balanceCard.addEventListener('click', () => showSection('transactions'));
    
    // Menu button
    menuBtn.addEventListener('click', () => showSection('settings'));
    
    // Fechar modais ao clicar fora
    window.addEventListener('click', function(event) {
        if (event.target === exportModal) closeModal(exportModal);
        if (event.target === exportProgressModal) closeModal(exportProgressModal);
        if (event.target === analysisModal) closeModal(analysisModal);
        if (event.target === confirmModal) closeModal(confirmModal);
        if (event.target === syncModal) closeModal(syncModal);
    });
    
    // Prevenir zoom em inputs no iOS
    document.addEventListener('touchstart', function(event) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') {
            event.target.style.fontSize = '16px';
        }
    }, { passive: true });
    
    // Swipe gestures para navega√ß√£o
    setupSwipeGestures();
}

// ========== FIREBASE FIRESTORE ==========

// Inicializar Firebase
async function initializeFirebase() {
    try {
        updateFirebaseStatus('connecting', 'Conectando ao Firebase...');
        
        // Esperar Firebase carregar
        await waitForFirebase();
        
        // Verificar se Firebase est√° dispon√≠vel
        if (!window.firebase || !window.firebase.auth) {
            throw new Error('Firebase n√£o carregou corretamente');
        }
        
        // Verificar se Authentication est√° habilitado
        try {
            await window.firebase.signInAnonymously(window.firebase.auth);
        } catch (authError) {
            console.warn('Authentication n√£o habilitado:', authError.message);
            
            // Criar um ID de usu√°rio local se o Auth n√£o estiver habilitado
            currentUserId = 'local-user-' + Math.random().toString(36).substr(2, 9);
            userId.textContent = 'Usu√°rio Local';
            userInfo.style.display = 'block';
            
            firebaseConnectionStatus = 'connected';
            updateFirebaseStatus('online', 'Trabalhando localmente');
            showToast('Firebase conectado (modo local)', 'success');
            
            // Desabilitar sincroniza√ß√£o
            isFirebaseSyncEnabled = false;
            firebaseSyncToggle.checked = false;
            saveSettings();
            
            return;
        }
        
        // Se chegou aqui, Auth est√° habilitado
        await setupFirebaseAuth();
        
    } catch (error) {
        console.error('Erro ao inicializar Firebase:', error);
        
        // Criar usu√°rio local em caso de erro
        currentUserId = 'local-user-' + Math.random().toString(36).substr(2, 9);
        userId.textContent = 'Usu√°rio Local';
        userInfo.style.display = 'block';
        
        updateFirebaseStatus('offline', 'Firebase offline - Trabalhando localmente');
        showToast('Conex√£o com Firebase falhou. Trabalhando offline.', 'warning');
        
        // Desabilitar sincroniza√ß√£o
        isFirebaseSyncEnabled = false;
        firebaseSyncToggle.checked = false;
        saveSettings();
    }
}

// Configurar autentica√ß√£o Firebase
async function setupFirebaseAuth() {
    const auth = window.firebase.auth;
    
    // Monitorar estado de autentica√ß√£o
    window.firebase.onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            userId.textContent = user.uid.substring(0, 8) + '...';
            userInfo.style.display = 'block';
            
            firebaseConnectionStatus = 'connected';
            updateFirebaseStatus('online', 'Firebase conectado');
            
            // Iniciar sincroniza√ß√£o em tempo real
            if (isFirebaseSyncEnabled) {
                await setupRealtimeSync();
            }
            
            // Carregar transa√ß√µes do Firebase
            await loadFromFirebase();
            
            showToast('Firebase conectado com sucesso!', 'success');
        } else {
            // Tentar login an√¥nimo
            try {
                const result = await window.firebase.signInAnonymously(auth);
                currentUserId = result.user.uid;
            } catch (error) {
                console.error('Erro no login an√¥nimo:', error);
                
                // Criar usu√°rio local
                currentUserId = 'local-user-' + Math.random().toString(36).substr(2, 9);
                userId.textContent = 'Usu√°rio Local';
                userInfo.style.display = 'block';
                
                updateFirebaseStatus('offline', 'Trabalhando localmente');
            }
        }
    });
}

// Esperar Firebase carregar
function waitForFirebase() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 30; // Aumentado para 30 tentativas
        const checkInterval = setInterval(() => {
            attempts++;
            if (window.firebase && window.firebase.db && window.firebase.auth) {
                clearInterval(checkInterval);
                resolve();
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                reject(new Error('Firebase n√£o carregou a tempo'));
            }
        }, 500);
    });
}

// Sair da conta
async function handleLogout() {
    try {
        if (window.firebase && window.firebase.auth) {
            await window.firebase.signOut(window.firebase.auth);
        }
        
        showToast('Sess√£o encerrada', 'info');
        userInfo.style.display = 'none';
        
        // Parar sincroniza√ß√£o em tempo real
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        
        // Criar novo usu√°rio local
        currentUserId = 'local-user-' + Math.random().toString(36).substr(2, 9);
        userId.textContent = 'Usu√°rio Local';
        userInfo.style.display = 'block';
        
        showToast('Modo local ativado', 'success');
        
    } catch (error) {
        console.error('Erro ao sair:', error);
        showToast('Erro ao sair', 'error');
    }
}

// Verificar conex√£o com Firebase
async function checkFirebaseConnection() {
    try {
        updateFirebaseStatus('connecting', 'Verificando conex√£o...');
        
        if (!window.firebase || !window.firebase.auth) {
            throw new Error('Firebase n√£o dispon√≠vel');
        }
        
        const auth = window.firebase.auth;
        const user = auth.currentUser;
        
        if (user) {
            firebaseConnectionStatus = 'connected';
            updateFirebaseStatus('online', 'Firebase conectado');
            return true;
        } else {
            // Tentar reconectar
            await initializeFirebase();
            return true;
        }
        
    } catch (error) {
        console.error('Erro ao conectar ao Firebase:', error);
        firebaseConnectionStatus = 'disconnected';
        updateFirebaseStatus('offline', 'Firebase offline - Trabalhando localmente');
        return false;
    }
}

// Atualizar status do Firebase na interface
function updateFirebaseStatus(status, message) {
    dbStatus.style.display = 'flex';
    dbStatus.className = `db-status ${status}`;
    dbStatusText.textContent = message;
    firebaseStatus.textContent = message;
    
    let icon = 'fa-database';
    if (status === 'online') icon = 'fa-database';
    if (status === 'offline') icon = 'fa-database';
    if (status === 'connecting') {
        icon = 'fa-spinner fa-spin';
        firebaseStatus.textContent = 'Conectando...';
    }
    
    dbStatusIcon.innerHTML = `<i class="fas ${icon}"></i>`;
    dbSyncBtn.style.display = status === 'offline' ? 'inline-flex' : 'none';
    
    // Atualizar √∫ltima sincroniza√ß√£o
    if (status === 'online') {
        lastSyncTime = new Date();
        lastSyncTimeElement.textContent = 'Agora';
    }
}

// Alternar sincroniza√ß√£o com Firebase
function toggleFirebaseSync() {
    isFirebaseSyncEnabled = firebaseSyncToggle.checked;
    saveSettings();
    
    if (isFirebaseSyncEnabled && firebaseConnectionStatus === 'connected') {
        // Ativar sincroniza√ß√£o
        setupRealtimeSync();
        showToast('Sincroniza√ß√£o em tempo real ativada', 'success');
    } else if (!isFirebaseSyncEnabled) {
        // Desativar sincroniza√ß√£o
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        showToast('Sincroniza√ß√£o em tempo real desativada', 'warning');
    } else {
        showToast('N√£o √© poss√≠vel ativar sincroniza√ß√£o sem conex√£o com Firebase', 'error');
        firebaseSyncToggle.checked = false;
    }
}

// Configurar sincroniza√ß√£o em tempo real
async function setupRealtimeSync() {
    if (!currentUserId || !isFirebaseSyncEnabled || !window.firebase) return;
    
    // Parar listener anterior se existir
    if (firebaseUnsubscribe) {
        firebaseUnsubscribe();
    }
    
    try {
        const userTransactionsRef = window.firebase.collection(
            window.firebase.db, 
            `users/${currentUserId}/transactions`
        );
        
        // Ordenar por data (mais recente primeiro)
        const q = window.firebase.query(
            userTransactionsRef,
            window.firebase.orderBy('date', 'desc')
        );
        
        firebaseUnsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
            firebaseTransactionsCount = snapshot.size;
            firebaseTransactionCount.textContent = firebaseTransactionsCount;
            cloudCount.textContent = firebaseTransactionsCount;
            
            // Atualizar √∫ltima sincroniza√ß√£o
            lastSyncTime = new Date();
            lastSyncTimeElement.textContent = 'Agora';
            
            updateFirebaseStatus('online', 'Sincronizado em tempo real');
            
        }, (error) => {
            console.error('Erro na sincroniza√ß√£o em tempo real:', error);
            updateFirebaseStatus('offline', 'Erro na sincroniza√ß√£o');
        });
    } catch (error) {
        console.error('Erro ao configurar sincroniza√ß√£o em tempo real:', error);
    }
}

// Carregar transa√ß√µes do Firebase
async function loadFromFirebase() {
    try {
        if (!currentUserId || !window.firebase) return;
        
        const userTransactionsRef = window.firebase.collection(
            window.firebase.db, 
            `users/${currentUserId}/transactions`
        );
        
        const q = window.firebase.query(
            userTransactionsRef,
            window.firebase.orderBy('date', 'desc')
        );
        
        const querySnapshot = await window.firebase.getDocs(q);
        const firebaseTransactions = [];
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            firebaseTransactions.push({
                id: doc.id,
                ...data,
                source: 'firebase'
            });
        });
        
        // Converter para o formato local
        const formattedTransactions = firebaseTransactions.map(t => ({
            id: t.id,
            description: t.description,
            amount: parseFloat(t.amount),
            type: t.type,
            category: t.category,
            date: t.date,
            source: 'firebase'
        }));
        
        // Substituir transa√ß√µes locais se houver dados no Firebase
        if (formattedTransactions.length > 0) {
            transactions = formattedTransactions;
            saveLocalTransactions();
            updateUI();
            
            showToast(`${formattedTransactions.length} transa√ß√µes carregadas da nuvem`, 'success');
        }
        
    } catch (error) {
        console.error('Erro ao carregar do Firebase:', error);
        // N√£o mostrar erro ao usu√°rio - pode ser que ainda n√£o haja dados
    }
}

// Sincronizar todas as transa√ß√µes para o Firebase
async function syncAllToFirebase() {
    if (!currentUserId || !window.firebase) {
        showToast('Firebase n√£o dispon√≠vel para sincroniza√ß√£o', 'error');
        return;
    }
    
    openModal(syncModal);
    syncProgress.style.width = '0%';
    syncStatus.textContent = 'Sincronizando com Firebase...';
    syncDetails.textContent = 'Preparando dados...';
    
    try {
        const userTransactionsRef = window.firebase.collection(
            window.firebase.db, 
            `users/${currentUserId}/transactions`
        );
        
        // Primeiro, obter transa√ß√µes existentes no Firebase
        const existingSnapshot = await window.firebase.getDocs(userTransactionsRef);
        
        syncProgress.style.width = '20%';
        syncDetails.textContent = 'Verificando transa√ß√µes existentes...';
        
        // Mapa de IDs existentes
        const existingIds = {};
        existingSnapshot.forEach(doc => {
            existingIds[doc.id] = true;
        });
        
        syncProgress.style.width = '40%';
        syncDetails.textContent = `Enviando ${transactions.length} transa√ß√µes...`;
        
        // Enviar transa√ß√µes
        let uploadedCount = 0;
        const batchSize = 5; // Reduzido para evitar timeout
        
        for (let i = 0; i < transactions.length; i += batchSize) {
            const batch = transactions.slice(i, i + batchSize);
            
            for (const transaction of batch) {
                // Usar ID local como ID no Firebase
                const transactionId = transaction.id.toString();
                
                try {
                    // Verificar se j√° existe
                    if (existingIds[transactionId]) {
                        // Atualizar
                        const transactionRef = window.firebase.doc(
                            window.firebase.db, 
                            `users/${currentUserId}/transactions/${transactionId}`
                        );
                        
                        await window.firebase.updateDoc(transactionRef, {
                            description: transaction.description,
                            amount: transaction.amount,
                            type: transaction.type,
                            category: transaction.category,
                            date: transaction.date,
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        // Criar novo
                        await window.firebase.setDoc(
                            window.firebase.doc(
                                window.firebase.db, 
                                `users/${currentUserId}/transactions/${transactionId}`
                            ),
                            {
                                description: transaction.description,
                                amount: transaction.amount,
                                type: transaction.type,
                                category: transaction.category,
                                date: transaction.date,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }
                        );
                    }
                    
                    uploadedCount++;
                    
                } catch (docError) {
                    console.error(`Erro ao sincronizar transa√ß√£o ${transactionId}:`, docError);
                }
                
                syncProgress.style.width = 40 + (uploadedCount / transactions.length * 40) + '%';
                syncDetails.textContent = `Enviando ${uploadedCount}/${transactions.length} transa√ß√µes...`;
            }
            
            // Pequena pausa entre lotes
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        syncProgress.style.width = '90%';
        syncStatus.textContent = 'Sincroniza√ß√£o conclu√≠da!';
        syncDetails.textContent = `${uploadedCount} transa√ß√µes processadas`;
        
        // Atualizar contagem
        firebaseTransactionsCount = transactions.length;
        firebaseTransactionCount.textContent = firebaseTransactionsCount;
        
        syncProgress.style.width = '100%';
        
        setTimeout(() => {
            closeModal(syncModal);
            showToast('Transa√ß√µes sincronizadas com sucesso!', 'success');
        }, 1500);
        
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        closeModal(syncModal);
        showToast('Erro na sincroniza√ß√£o. Trabalhando localmente.', 'error');
    }
}

// Salvar uma transa√ß√£o no Firebase
async function saveTransactionToFirebase(transaction) {
    if (!currentUserId || !isFirebaseSyncEnabled || !window.firebase) {
        return false;
    }
    
    try {
        const transactionRef = window.firebase.doc(
            window.firebase.db, 
            `users/${currentUserId}/transactions/${transaction.id}`
        );
        
        await window.firebase.setDoc(transactionRef, {
            description: transaction.description,
            amount: transaction.amount,
            type: transaction.type,
            category: transaction.category,
            date: transaction.date,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        return true;
    } catch (error) {
        console.error('Erro ao salvar transa√ß√£o no Firebase:', error);
        return false;
    }
}

// Excluir transa√ß√£o do Firebase
async function deleteTransactionFromFirebase(transactionId) {
    if (!currentUserId || !window.firebase) return;
    
    try {
        const transactionRef = window.firebase.doc(
            window.firebase.db, 
            `users/${currentUserId}/transactions/${transactionId}`
        );
        
        await window.firebase.deleteDoc(transactionRef);
        return true;
    } catch (error) {
        console.error('Erro ao excluir transa√ß√£o do Firebase:', error);
        return false;
    }
}

// Limpar todas as transa√ß√µes do Firebase
async function clearFirebaseTransactions() {
    if (!currentUserId || !window.firebase) return;
    
    openModal(syncModal);
    syncProgress.style.width = '0%';
    syncStatus.textContent = 'Limpando transa√ß√µes do Firebase...';
    syncDetails.textContent = 'Preparando...';
    
    try {
        const userTransactionsRef = window.firebase.collection(
            window.firebase.db, 
            `users/${currentUserId}/transactions`
        );
        
        const querySnapshot = await window.firebase.getDocs(userTransactionsRef);
        
        syncProgress.style.width = '30%';
        syncDetails.textContent = `Excluindo ${querySnapshot.size} transa√ß√µes...`;
        
        // Excluir em lotes
        let deletedCount = 0;
        const batchSize = 5;
        
        for (let i = 0; i < querySnapshot.docs.length; i += batchSize) {
            const batch = querySnapshot.docs.slice(i, i + batchSize);
            const deletePromises = batch.map(doc => window.firebase.deleteDoc(doc.ref));
            
            await Promise.all(deletePromises);
            
            deletedCount += batch.length;
            syncProgress.style.width = 30 + (deletedCount / querySnapshot.size * 60) + '%';
            syncDetails.textContent = `Excluindo ${deletedCount}/${querySnapshot.size} transa√ß√µes...`;
            
            // Pequena pausa entre lotes
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        syncProgress.style.width = '100%';
        syncStatus.textContent = 'Limpeza conclu√≠da!';
        syncDetails.textContent = `${deletedCount} transa√ß√µes exclu√≠das`;
        
        // Atualizar contagem
        firebaseTransactionsCount = 0;
        firebaseTransactionCount.textContent = '0';
        
        setTimeout(() => {
            closeModal(syncModal);
            showToast('Firebase limpo com sucesso!', 'success');
        }, 1500);
        
    } catch (error) {
        console.error('Erro ao limpar Firebase:', error);
        closeModal(syncModal);
        showToast('Erro ao limpar Firebase', 'error');
    }
}

// Confirmar limpeza do Firebase
function showClearFirebaseConfirm() {
    confirmMessage.textContent = 'Tem certeza que deseja apagar TODAS as transa√ß√µes do Firebase? Esta a√ß√£o n√£o pode ser desfeita.';
    
    confirmAction.onclick = function() {
        clearFirebaseTransactions();
        closeModal(confirmModal);
    };
    
    openModal(confirmModal);
}

// ========== SISTEMA DE EXPORTA√á√ÉO EXCEL ==========

// Alternar visibilidade dos filtros de exporta√ß√£o
function toggleExportFilters() {
    exportFilters.classList.toggle('show');
}

// Iniciar exporta√ß√£o a partir do modal
function handleStartExport() {
    closeModal(exportModal);
    handleExportExcel(selectedExportType);
}

// Exportar para Excel
function handleExportExcel(type = 'full') {
    if (transactions.length === 0) {
        showToast('Adicione transa√ß√µes primeiro', 'error');
        return;
    }
    
    // Mostrar modal de progresso
    openModal(exportProgressModal);
    exportProgress.style.width = '0%';
    exportStatus.textContent = 'Preparando dados para exporta√ß√£o...';
    exportDetails.textContent = 'Processando transa√ß√µes...';
    
    // Filtrar transa√ß√µes conforme o tipo
    let filteredTransactions = [...transactions];
    
    switch(type) {
        case 'monthly':
            filteredTransactions = getMonthlyTransactions();
            break;
        case 'categories':
            filteredTransactions = getExpenseTransactions();
            break;
        case 'custom':
            filteredTransactions = getCustomFilteredTransactions();
            break;
    }
    
    // Atualizar progresso
    exportProgress.style.width = '30%';
    exportStatus.textContent = 'Calculando totais...';
    exportDetails.textContent = `Processando ${filteredTransactions.length} transa√ß√µes...`;
    
    // Calcular totais
    setTimeout(() => {
        const totalIncome = filteredTransactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);
            
        const totalExpense = filteredTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);
            
        const totalBalance = totalIncome - totalExpense;
        
        exportProgress.style.width = '60%';
        exportStatus.textContent = 'Criando planilha...';
        exportDetails.textContent = 'Formatando dados para Excel...';
        
        // Criar dados para exporta√ß√£o
        const exportData = createExportData(filteredTransactions, totalIncome, totalExpense, totalBalance, type);
        
        exportProgress.style.width = '80%';
        exportStatus.textContent = 'Gerando arquivo...';
        exportDetails.textContent = 'Preparando download...';
        
        // Criar planilha
        setTimeout(() => {
            try {
                const worksheet = XLSX.utils.aoa_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                
                // Configurar larguras das colunas
                const colWidths = [
                    {wch: 12},  // Data
                    {wch: 30},  // Descri√ß√£o
                    {wch: 15},  // Categoria
                    {wch: 10},  // Tipo
                    {wch: 15},  // Valor
                    {wch: 20}   // Observa√ß√µes
                ];
                worksheet['!cols'] = colWidths;
                
                // Adicionar planilha ao workbook
                let sheetName = 'Relat√≥rio Financeiro';
                switch(type) {
                    case 'monthly': sheetName = 'Relat√≥rio Mensal'; break;
                    case 'categories': sheetName = 'An√°lise Categorias'; break;
                    case 'custom': sheetName = 'Relat√≥rio Personalizado'; break;
                }
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                
                // Gerar nome do arquivo
                const fileName = generateFileName(type);
                
                exportProgress.style.width = '100%';
                exportStatus.textContent = 'Download iniciado!';
                exportDetails.textContent = 'Seu arquivo est√° sendo baixado...';
                
                // Gerar e fazer download do arquivo
                XLSX.writeFile(workbook, fileName);
                
                // Fechar modal ap√≥s 2 segundos
                setTimeout(() => {
                    closeModal(exportProgressModal);
                    showToast(`Excel exportado com sucesso! (${filteredTransactions.length} transa√ß√µes)`, 'success');
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                closeModal(exportProgressModal);
                showToast('Erro ao exportar Excel', 'error');
            }
        }, 500);
        
    }, 500);
}

// Filtrar transa√ß√µes do m√™s atual
function getMonthlyTransactions() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    return transactions.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate >= firstDay && transactionDate <= lastDay;
    });
}

// Filtrar apenas despesas (para an√°lise por categoria)
function getExpenseTransactions() {
    return transactions.filter(t => t.type === 'expense');
}

// Filtrar transa√ß√µes personalizadas
function getCustomFilteredTransactions() {
    let filtered = [...transactions];
    
    // Filtrar por data
    if (startDateInput.value && endDateInput.value) {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        filtered = filtered.filter(t => {
            const transactionDate = new Date(t.date);
            return transactionDate >= startDate && transactionDate <= endDate;
        });
    }
    
    // Filtrar por tipo
    const includeIncome = filterIncome.checked;
    const includeExpense = filterExpense.checked;
    
    if (!includeIncome || !includeExpense) {
        filtered = filtered.filter(t => {
            if (includeIncome && t.type === 'income') return true;
            if (includeExpense && t.type === 'expense') return true;
            return false;
        });
    }
    
    return filtered;
}

// Criar dados para exporta√ß√£o
function createExportData(transactions, totalIncome, totalExpense, totalBalance, type) {
    const data = [];
    
    // Cabe√ßalho do relat√≥rio
    let reportTitle = 'RELAT√ìRIO FINANCEIRO - FINANCEPRO';
    switch(type) {
        case 'monthly': 
            reportTitle = 'RELAT√ìRIO FINANCEIRO MENSAL - FINANCEPRO';
            break;
        case 'categories': 
            reportTitle = 'AN√ÅLISE DE GASTOS POR CATEGORIA - FINANCEPRO';
            break;
        case 'custom': 
            reportTitle = 'RELAT√ìRIO FINANCEIRO PERSONALIZADO - FINANCEPRO';
            break;
    }
    
    data.push([reportTitle]);
    data.push([]);
    data.push(['Data de Exporta√ß√£o:', new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR')]);
    data.push(['Total de Transa√ß√µes:', transactions.length]);
    data.push([]);
    
    // Resumo financeiro
    data.push(['RESUMO FINANCEIRO']);
    data.push(['Renda Total:', totalIncome.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})]);
    data.push(['Despesas Totais:', totalExpense.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})]);
    data.push(['Saldo Final:', totalBalance.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})]);
    
    // An√°lise por categoria (se for do tipo categorias ou completo)
    if (type === 'categories' || type === 'full') {
        data.push([]);
        data.push(['AN√ÅLISE DE GASTOS POR CATEGORIA']);
        
        const categoryTotals = {};
        transactions
            .filter(t => t.type === 'expense')
            .forEach(t => {
                if (!categoryTotals[t.category]) categoryTotals[t.category] = 0;
                categoryTotals[t.category] += t.amount;
            });
        
        // Ordenar categorias por valor (maior para menor)
        const sortedCategories = Object.entries(categoryTotals)
            .sort(([,a], [,b]) => b - a);
        
        sortedCategories.forEach(([category, total]) => {
            const percentage = (total / totalExpense * 100).toFixed(1);
            const categoryName = getCategoryName(category);
            data.push([categoryName, total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}), `${percentage}%`]);
        });
    }
    
    data.push([]);
    data.push(['DETALHAMENTO DAS TRANSA√á√ïES']);
    data.push(['Data', 'Descri√ß√£o', 'Categoria', 'Tipo', 'Valor (R$)', 'Observa√ß√µes']);
    
    // Ordenar transa√ß√µes por data (mais recente primeiro)
    const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedTransactions.forEach(t => {
        const typeText = t.type === 'income' ? 'Renda' : 'Despesa';
        const categoryText = getCategoryName(t.category);
        const dateText = new Date(t.date).toLocaleDateString('pt-BR');
        
        // Adicionar observa√ß√µes especiais
        let observations = '';
        if (t.amount > 1000 && t.type === 'expense') observations = 'GASTO ALTO';
        if (t.category === 'investment') observations = 'INVESTIMENTO';
        if (t.description.toLowerCase().includes('extra')) observations = 'RENDA EXTRA';
        
        data.push([
            dateText,
            t.description,
            categoryText,
            typeText,
            t.amount,
            observations
        ]);
    });
    
    // Adicionar f√≥rmulas Excel para totais
    const lastRow = data.length;
    data.push([]);
    data.push(['TOTAIS AUTOM√ÅTICOS (Excel)']);
    data.push(['Soma Rendas:', {f: `SUMIF(D2:D${lastRow},"Renda",E2:E${lastRow})`}]);
    data.push(['Soma Despesas:', {f: `SUMIF(D2:D${lastRow},"Despesa",E2:E${lastRow})`}]);
    data.push(['Saldo:', {f: `SUMIF(D2:D${lastRow},"Renda",E2:E${lastRow})-SUMIF(D2:D${lastRow},"Despesa",E2:E${lastRow})`}]);
    
    return data;
}

// Gerar nome do arquivo
function generateFileName(type) {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10);
    
    let prefix = 'FinancePro';
    switch(type) {
        case 'monthly': 
            prefix = 'FinancePro_Mensal';
            break;
        case 'categories': 
            prefix = 'FinancePro_Categorias';
            break;
        case 'custom': 
            prefix = 'FinancePro_Personalizado';
            break;
    }
    
    return `${prefix}_${dateStr}.xlsx`;
}

// Exportar backup JSON
function handleExportBackup() {
    if (transactions.length === 0) {
        showToast('N√£o h√° dados para exportar', 'error');
        return;
    }
    
    const dataStr = JSON.stringify({
        transactions: transactions,
        exportDate: new Date().toISOString(),
        totalTransactions: transactions.length,
        appVersion: '1.0'
    }, null, 2);
    
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `FinancePro_Backup_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Backup exportado com sucesso!', 'success');
}

// ========== FUN√á√ïES PRINCIPAIS ==========

// Carregar configura√ß√µes
function loadSettings() {
    const storedSettings = localStorage.getItem('financeProSettings');
    if (storedSettings) {
        try {
            const settings = JSON.parse(storedSettings);
            isFirebaseSyncEnabled = settings.firebaseSyncEnabled !== undefined ? settings.firebaseSyncEnabled : true;
            lastSyncTime = settings.lastSyncTime ? new Date(settings.lastSyncTime) : null;
            
            firebaseSyncToggle.checked = isFirebaseSyncEnabled;
            
            if (lastSyncTime) {
                lastSyncTimeElement.textContent = lastSyncTime.toLocaleString('pt-BR');
            }
        } catch (e) {
            console.error('Erro ao carregar configura√ß√µes:', e);
        }
    }
}

// Salvar configura√ß√µes
function saveSettings() {
    const settings = {
        firebaseSyncEnabled: isFirebaseSyncEnabled,
        lastSyncTime: lastSyncTime ? lastSyncTime.toISOString() : null
    };
    localStorage.setItem('financeProSettings', JSON.stringify(settings));
}

// Carregar transa√ß√µes do localStorage
function loadLocalTransactions() {
    const storedTransactions = localStorage.getItem('financeProTransactions');
    if (storedTransactions) {
        try {
            transactions = JSON.parse(storedTransactions);
        } catch (e) {
            console.error('Erro ao carregar transa√ß√µes:', e);
            transactions = [];
        }
    }
    updateUI();
}

// Salvar transa√ß√µes no localStorage
function saveLocalTransactions() {
    localStorage.setItem('financeProTransactions', JSON.stringify(transactions));
    updateSystemInfo();
}

// Atualizar toda a interface
function updateUI() {
    updateTransactionTable();
    updateSummary();
    updateCharts();
    toggleEmptyState();
    updateSystemInfo();
}

// Atualizar informa√ß√µes do sistema
function updateSystemInfo() {
    transactionCount.textContent = transactions.length;
    cloudCount.textContent = firebaseTransactionsCount;
    
    if (transactions.length > 0) {
        const dates = transactions.map(t => new Date(t.date));
        const latestDate = new Date(Math.max(...dates));
        lastUpdate.textContent = latestDate.toLocaleDateString('pt-BR');
    } else {
        lastUpdate.textContent = '-';
    }
    
    // Calcular espa√ßo utilizado
    const dataStr = JSON.stringify(transactions);
    const bytes = new TextEncoder().encode(dataStr).length;
    const kb = (bytes / 1024).toFixed(2);
    storageUsed.textContent = `${kb} KB`;
}

// Mostrar/ocultar estado vazio
function toggleEmptyState() {
    if (transactions.length === 0) {
        emptyTransactions.style.display = 'block';
        document.querySelector('table').style.display = 'none';
    } else {
        emptyTransactions.style.display = 'none';
        document.querySelector('table').style.display = 'table';
    }
}

// Atualizar tabela de transa√ß√µes
function updateTransactionTable() {
    transactionsBody.innerHTML = '';
    
    // Ordenar por data (mais recente primeiro)
    const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Mostrar apenas as √∫ltimas 10 transa√ß√µes na tabela principal
    const recentTransactions = sortedTransactions.slice(0, 10);
    
    recentTransactions.forEach((transaction) => {
        const row = document.createElement('tr');
        
        const dateObj = new Date(transaction.date);
        const formattedDate = dateObj.toLocaleDateString('pt-BR');
        
        const categoryClass = `category-${transaction.category}`;
        const typeClass = transaction.type === 'income' ? 'transaction-income' : 'transaction-expense';
        
        const formattedValue = transaction.amount.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });
        
        const categoryTextMap = {
            'salary': 'Sal√°rio',
            'investment': 'Investimentos',
            'food': 'Alimenta√ß√£o',
            'transport': 'Transporte',
            'housing': 'Moradia',
            'utilities': 'Contas',
            'entertainment': 'Lazer',
            'health': 'Sa√∫de',
            'education': 'Educa√ß√£o',
            'other': 'Outros'
        };
        
        const sourceIcon = transaction.source === 'firebase' 
            ? '<i class="fas fa-cloud" title="Firebase"></i>' 
            : '<i class="fas fa-mobile-alt" title="Local"></i>';
        
        row.innerHTML = `
            <td><strong>${formattedDate}</strong></td>
            <td>${transaction.description}</td>
            <td><span class="transaction-category ${categoryClass}">${categoryTextMap[transaction.category]}</span></td>
            <td class="${typeClass}"><strong>${formattedValue}</strong></td>
            <td style="text-align: center;">${sourceIcon}</td>
            <td>
                <button class="delete-btn" onclick="deleteTransaction(${transaction.id})" title="Excluir">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        
        transactionsBody.appendChild(row);
    });
    
    // Se houver mais transa√ß√µes, mostrar contador
    if (sortedTransactions.length > 10) {
        const moreRow = document.createElement('tr');
        moreRow.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                <i class="fas fa-ellipsis-h"></i> 
                Mais ${sortedTransactions.length - 10} transa√ß√µes no hist√≥rico completo
            </td>
        `;
        transactionsBody.appendChild(moreRow);
    }
}

// Atualizar resumo financeiro
function updateSummary() {
    const totalIncome = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const totalExpense = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const totalBalance = totalIncome - totalExpense;
    
    totalIncomeElement.textContent = totalIncome.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    
    totalExpenseElement.textContent = totalExpense.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    
    totalBalanceElement.textContent = totalBalance.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    
    // Atualizar cor do saldo
    if (totalBalance < 0) {
        totalBalanceElement.style.color = 'var(--danger)';
    } else if (totalBalance === 0) {
        totalBalanceElement.style.color = 'var(--warning)';
    } else {
        totalBalanceElement.style.color = 'var(--success)';
    }
    
    // Anima√ß√£o nos cards
    animateCardValue(totalIncomeElement, totalIncome);
    animateCardValue(totalExpenseElement, totalExpense);
    animateCardValue(totalBalanceElement, totalBalance);
}

// Anima√ß√£o de valores nos cards
function animateCardValue(element, newValue) {
    element.style.transform = 'scale(1.1)';
    element.style.transition = 'transform 0.3s ease';
    
    setTimeout(() => {
        element.style.transform = 'scale(1)';
    }, 300);
}

// Atualizar gr√°ficos
function updateCharts() {
    updateCategoryChart();
    updateMonthlyChart();
}

// Gr√°fico de categorias
function updateCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    
    const categoryTotals = {};
    transactions
        .filter(t => t.type === 'expense')
        .forEach(transaction => {
            if (!categoryTotals[transaction.category]) {
                categoryTotals[transaction.category] = 0;
            }
            categoryTotals[transaction.category] += transaction.amount;
        });
    
    if (Object.keys(categoryTotals).length === 0) {
        if (categoryChart) categoryChart.destroy();
        
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sem dados'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                cutout: '70%'
            }
        });
        return;
    }
    
    const categoryLabels = {
        'salary': 'Sal√°rio',
        'investment': 'Investimentos',
        'food': 'Alimenta√ß√£o',
        'transport': 'Transporte',
        'housing': 'Moradia',
        'utilities': 'Contas',
        'entertainment': 'Lazer',
        'health': 'Sa√∫de',
        'education': 'Educa√ß√£o',
        'other': 'Outros'
    };
    
    // Cores em tons de cinza para preto e branco
    const categoryColors = {
        'salary': '#000000',
        'investment': '#333333',
        'food': '#666666',
        'transport': '#888888',
        'housing': '#444444',
        'utilities': '#555555',
        'entertainment': '#777777',
        'health': '#222222',
        'education': '#999999',
        'other': '#aaaaaa'
    };
    
    const labels = Object.keys(categoryTotals).map(cat => categoryLabels[cat]);
    const data = Object.values(categoryTotals);
    const backgroundColors = Object.keys(categoryTotals).map(cat => categoryColors[cat] || '#cccccc');
    
    if (categoryChart) categoryChart.destroy();
    
    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            return `${context.label}: ${value.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
                        }
                    }
                }
            },
            cutout: '70%'
        }
    });
}

// Gr√°fico mensal
function updateMonthlyChart() {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    
    // Agrupar por m√™s (√∫ltimos 6 meses)
    const monthlyData = {};
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
    
    transactions.forEach(transaction => {
        const date = new Date(transaction.date);
        if (date < sixMonthsAgo) return;
        
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { income: 0, expense: 0 };
        }
        
        if (transaction.type === 'income') {
            monthlyData[monthKey].income += transaction.amount;
        } else {
            monthlyData[monthKey].expense += transaction.amount;
        }
    });
    
    // Ordenar por m√™s
    const sortedMonths = Object.keys(monthlyData).sort();
    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    
    const labels = sortedMonths.map(key => {
        const [year, month] = key.split('-');
        return `${monthNames[parseInt(month)]}`;
    });
    
    const incomeData = sortedMonths.map(key => monthlyData[key].income);
    const expenseData = sortedMonths.map(key => monthlyData[key].expense);
    
    if (monthlyChart) monthlyChart.destroy();
    
    // Se n√£o houver dados suficientes
    if (sortedMonths.length < 2) {
        monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Fev', 'Mar'],
                datasets: [
                    {
                        label: 'Renda',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        borderColor: '#000000',
                        borderWidth: 1
                    },
                    {
                        label: 'Despesas',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(102, 102, 102, 0.5)',
                        borderColor: '#666666',
                        borderWidth: 1
                    }
                ]
            },
            options: getChartOptions()
        });
        return;
    }
    
    monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Renda',
                    data: incomeData,
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    borderColor: '#000000',
                    borderWidth: 1
                },
                {
                    label: 'Despesas',
                    data: expenseData,
                    backgroundColor: 'rgba(102, 102, 102, 0.7)',
                    borderColor: '#666666',
                    borderWidth: 1
                }
            ]
        },
        options: getChartOptions()
    });
}

// Op√ß√µes do gr√°fico
function getChartOptions() {
    return {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                grid: { display: false },
                ticks: { maxRotation: 0 }
            },
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        if (value >= 1000) return 'R$' + (value/1000).toFixed(0) + 'k';
                        return 'R$' + value;
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
                labels: { boxWidth: 12 }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    };
}

// Adicionar transa√ß√£o
async function handleAddTransaction(e) {
    e.preventDefault();
    
    const description = document.getElementById('description').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    const type = document.getElementById('type').value;
    const category = document.getElementById('category').value;
    const date = document.getElementById('date').value;
    
    if (!description || isNaN(amount) || amount <= 0) {
        showToast('Preencha todos os campos corretamente', 'error');
        return;
    }
    
    const transaction = {
        id: Date.now() + Math.random(),
        description,
        amount,
        type,
        category,
        date,
        source: 'local'
    };
    
    transactions.push(transaction);
    saveLocalTransactions();
    updateUI();
    
    // Salvar no Firebase se a sincroniza√ß√£o estiver ativada
    if (isFirebaseSyncEnabled && firebaseConnectionStatus === 'connected') {
        const savedToFirebase = await saveTransactionToFirebase(transaction);
        if (savedToFirebase) {
            transaction.source = 'firebase';
            showToast('Transa√ß√£o salva localmente e na nuvem!', 'success');
        } else {
            showToast('Transa√ß√£o salva localmente (erro na nuvem)', 'warning');
        }
    } else {
        showToast(`${type === 'income' ? 'Renda' : 'Despesa'} adicionada com sucesso!`, 'success');
    }
    
    // Resetar formul√°rio
    transactionForm.reset();
    document.getElementById('date').valueAsDate = new Date();
    
    // Vibrar se suportado
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
    
    // Voltar para o dashboard
    setTimeout(() => showSection('dashboard'), 500);
}

// Excluir transa√ß√£o
async function deleteTransaction(transactionId) {
    // Confirma√ß√£o t√°til
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    
    const transaction = transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    if (confirm(`Excluir transa√ß√£o "${transaction.description}"?`)) {
        // Remover localmente
        transactions = transactions.filter(t => t.id !== transactionId);
        saveLocalTransactions();
        updateUI();
        
        // Remover do Firebase se existir
        if (isFirebaseSyncEnabled && transaction.source === 'firebase') {
            await deleteTransactionFromFirebase(transactionId);
        }
        
        showToast(`Transa√ß√£o "${transaction.description}" exclu√≠da`, 'warning');
    }
}

// Obter nome da categoria
function getCategoryName(category) {
    const map = {
        'salary': 'Sal√°rio',
        'investment': 'Investimentos',
        'food': 'Alimenta√ß√£o',
        'transport': 'Transporte',
        'housing': 'Moradia',
        'utilities': 'Contas',
        'entertainment': 'Lazer',
        'health': 'Sa√∫de',
        'education': 'Educa√ß√£o',
        'other': 'Outros'
    };
    return map[category] || category;
}

// ========== CONFIGURA√á√ïES ==========

// Dados de exemplo
async function handleSampleData() {
    closeModal(confirmModal);
    
    if (transactions.length > 0 && !confirm('Substituir dados atuais por dados de exemplo?')) {
        return;
    }
    
    const today = new Date();
    const oneWeekAgo = new Date(today);
    oneWeekAgo.setDate(today.getDate() - 7);
    const twoWeeksAgo = new Date(today);
    twoWeeksAgo.setDate(today.getDate() - 14);
    
    const sampleData = [
        {
            id: Date.now() + 1,
            description: 'Sal√°rio Mensal',
            amount: 3500.00,
            type: 'income',
            category: 'salary',
            date: today.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 2,
            description: 'Supermercado Semanal',
            amount: 450.00,
            type: 'expense',
            category: 'food',
            date: today.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 3,
            description: 'Aluguel',
            amount: 1200.00,
            type: 'expense',
            category: 'housing',
            date: today.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 4,
            description: 'Transporte',
            amount: 200.00,
            type: 'expense',
            category: 'transport',
            date: today.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 5,
            description: 'Freelance',
            amount: 800.00,
            type: 'income',
            category: 'salary',
            date: oneWeekAgo.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 6,
            description: 'Restaurante',
            amount: 120.00,
            type: 'expense',
            category: 'food',
            date: oneWeekAgo.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 7,
            description: 'Netflix',
            amount: 39.90,
            type: 'expense',
            category: 'entertainment',
            date: oneWeekAgo.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 8,
            description: 'Consulta M√©dica',
            amount: 150.00,
            type: 'expense',
            category: 'health',
            date: twoWeeksAgo.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 9,
            description: 'Livros',
            amount: 89.90,
            type: 'expense',
            category: 'education',
            date: twoWeeksAgo.toISOString().slice(0, 10),
            source: 'local'
        },
        {
            id: Date.now() + 10,
            description: 'Investimento',
            amount: 500.00,
            type: 'expense',
            category: 'investment',
            date: twoWeeksAgo.toISOString().slice(0, 10),
            source: 'local'
        }
    ];
    
    transactions = sampleData;
    saveLocalTransactions();
    updateUI();
    
    // Sincronizar com Firebase se ativado
    if (isFirebaseSyncEnabled && firebaseConnectionStatus === 'connected') {
        await syncAllToFirebase();
    }
    
    showToast('Dados de exemplo carregados!', 'success');
    showSection('dashboard');
}

// Limpar hist√≥rico
function showClearHistoryConfirm() {
    confirmMessage.textContent = 'Tem certeza que deseja apagar TODAS as transa√ß√µes permanentemente? Esta a√ß√£o n√£o pode ser desfeita.';
    
    confirmAction.onclick = function() {
        clearAllTransactions();
        closeModal(confirmModal);
    };
    
    openModal(confirmModal);
}

function clearAllTransactions() {
    transactions = [];
    saveLocalTransactions();
    updateUI();
    
    showToast('Hist√≥rico apagado com sucesso!', 'warning');
    showSection('dashboard');
}

// Modo escuro
function toggleDarkMode() {
    const isDark = document.body.hasAttribute('data-dark-mode');
    
    if (isDark) {
        document.body.removeAttribute('data-dark-mode');
        localStorage.setItem('financeProDarkMode', 'false');
        darkModeToggle.checked = false;
        showToast('Modo claro ativado', 'success');
    } else {
        document.body.setAttribute('data-dark-mode', 'true');
        localStorage.setItem('financeProDarkMode', 'true');
        darkModeToggle.checked = true;
        showToast('Modo escuro ativado', 'success');
    }
}

function checkDarkMode() {
    const saved = localStorage.getItem('financeProDarkMode');
    if (saved === 'true') {
        document.body.setAttribute('data-dark-mode', 'true');
        darkModeToggle.checked = true;
    }
}

// ========== NAVEGA√á√ÉO ==========

// Configurar gestos de swipe
function setupSwipeGestures() {
    let startX = 0;
    let startY = 0;
    
    document.addEventListener('touchstart', function(event) {
        startX = event.touches[0].clientX;
        startY = event.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', function(event) {
        if (!startX || !startY) return;
        
        const endX = event.changedTouches[0].clientX;
        const endY = event.changedTouches[0].clientY;
        
        const diffX = startX - endX;
        const diffY = startY - endY;
        
        // Verificar se √© um swipe horizontal (n√£o vertical)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
                // Swipe para a esquerda
                navigateNextSection();
            } else {
                // Swipe para a direita
                navigatePrevSection();
            }
        }
        
        startX = 0;
        startY = 0;
    }, { passive: true });
}

// Navega√ß√£o entre se√ß√µes
const sections = ['dashboard', 'add', 'transactions', 'settings'];

function navigateNextSection() {
    const currentIndex = sections.indexOf(currentSection);
    const nextIndex = (currentIndex + 1) % sections.length;
    showSection(sections[nextIndex]);
}

function navigatePrevSection() {
    const currentIndex = sections.indexOf(currentSection);
    const prevIndex = (currentIndex - 1 + sections.length) % sections.length;
    showSection(sections[prevIndex]);
}

function showSection(section) {
    // Atualizar se√ß√£o atual
    currentSection = section;
    
    // Esconder todas as se√ß√µes
    dataEntrySection.style.display = 'none';
    transactionsSection.style.display = 'none';
    reportsSection.style.display = 'none';
    settingsSection.style.display = 'none';
    
    // Atualizar navega√ß√£o ativa
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    // Mostrar se√ß√£o selecionada e atualizar navega√ß√£o
    switch(section) {
        case 'dashboard':
            navDashboard.classList.add('active');
            break;
        case 'add':
            dataEntrySection.style.display = 'block';
            navAdd.classList.add('active');
            // Focar no primeiro campo
            setTimeout(() => document.getElementById('description').focus(), 100);
            break;
        case 'transactions':
            transactionsSection.style.display = 'block';
            navTransactions.classList.add('active');
            break;
        case 'settings':
            settingsSection.style.display = 'block';
            navSettings.classList.add('active');
            // Ocultar filtros de exporta√ß√£o
            exportFilters.classList.remove('show');
            break;
    }
    
    // Scroll para o topo
    window.scrollTo(0, 0);
}

// Filtrar por tipo
function filterByType(type) {
    showSection('add');
    
    setTimeout(() => {
        document.getElementById('type').value = type;
        showToast(`Filtro: ${type === 'income' ? 'Renda' : 'Despesa'}`, 'info');
    }, 100);
}

// ========== UTILIT√ÅRIOS ==========

// Abrir modal
function openModal(modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Vibrar levemente
    if (navigator.vibrate) navigator.vibrate(30);
}

// Fechar modal
function closeModal(modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Mostrar toast
function showToast(message, type = 'info') {
    toast.textContent = message;
    toast.className = 'toast';
    
    // Cor baseada no tipo
    if (type === 'success') {
        toast.style.background = 'var(--dark)';
    } else if (type === 'error') {
        toast.style.background = 'var(--danger)';
    } else if (type === 'warning') {
        toast.style.background = 'var(--warning)';
    } else {
        toast.style.background = 'var(--secondary)';
    }
    
    toast.classList.add('show');
    
    // Ocultar ap√≥s 3 segundos
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
    
    // Vibrar
    if (navigator.vibrate) {
        navigator.vibrate(type === 'error' ? [200, 100, 200] : 100);
    }
}

// Suporte a PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').catch(function(error) {
            console.log('ServiceWorker registration failed:', error);
        });
    });
}

// Detectar se est√° em modo standalone
if (window.matchMedia('(display-mode: standalone)').matches) {
    document.body.setAttribute('data-standalone', 'true');
}

// Tornar fun√ß√µes dispon√≠veis globalmente
window.deleteTransaction = deleteTransaction;
window.showSection = showSection;

// ========== INSTRU√á√ïES PARA HABILITAR FIREBASE AUTHENTICATION ==========
/*
Para habilitar o Firebase Authentication:

1. Acesse o Firebase Console: https://console.firebase.google.com/
2. Selecione seu projeto "financeiro-e4c33"
3. No menu lateral, clique em "Authentication"
4. Clique na aba "M√©todos de login"
5. Clique em "Primeiros passos"
6. Habilite o m√©todo "Login An√¥nimo"
7. Clique em "Salvar"

Se quiser usar outros m√©todos de login (como Email/Senha):
1. Na mesma p√°gina "M√©todos de login"
2. Habilite "Email/Senha" ou outros m√©todos desejados
3. Clique em "Salvar"

Ap√≥s habilitar o Authentication, recarregue o aplicativo.
*/
    </script>
</body>
</html>
